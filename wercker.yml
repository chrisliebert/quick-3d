# Copyright (C) 2016 Chris Liebert

# This references a standard debian container from the
# Docker Hub https://registry.hub.docker.com/_/debian/
# Read more about containers on our dev center
# http://devcenter.wercker.com/docs/containers/index.html
box: debian

build:
  steps:
    - install-packages:
        packages: curl file build-essential cmake swig liblua5.1-dev lua5.1 openjdk-7-jdk python-all-dev mono-mcs
    - script:
        name: install-rust
        code: |
            curl https://static.rust-lang.org/rustup.sh --output rustup.sh
            sh rustup.sh --disable-sudo
    - script:
        name: build-quick3d
        code: |
            cargo build
    - script:
        name: build-ffi-c
        code: |
            cd ffi/C
            cargo build
            cd ../..
    - script:
        name: build-ffi-csharp
        code: |
            cd ffi/CSharp
            cargo build
            cd ../..
        name: build-ffi-java
    - script:
        code: |
            cd ffi/Java
            export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64
            cargo build
            cd ../..
    - script:
        name: build-ffi-lua
        code: |
            cd ffi/Lua
            - export LUA_INCLUDE_DIR=/usr/include/lua5.1
            - export LUA_LIBRARY=/usr/lib/x86_64-linux-gnu/liblua5.1.a
            - export LUA_LIBRARIES=/usr/lib/x86_64-linux-gnu/liblua5.1.a
            cargo build
            cd ../..
    - script:
        name: build-ffi-python
        code: |
            cd ffi/Python
            cargo build
            cd ../..
    - script:
        name: test-quick3d
        code: |
            cargo test --verbose
            cd ffi/C
            cargo test --verbose
            ./c_example
            cd ../CSharp
            cargo test --verbose
            mcs *.cs
            cd ../Java
            cargo test --verbose
            export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64
            export LD_LIBRARY_PATH=`pwd`
            javac *.java
            java Quick3DTests
            cd ../Lua
            cargo test --verbose
            export LD_LIBRARY_PATH=`pwd`
            lua5.1 test.lua
            cd ../Python
            cargo test --verbose
            export LD_LIBRARY_PATH=`pwd`
            python test.py
